"\"\"\"\n可视化模板库\n管理和应用预定义的可视化模板\n\"\"\"\n\nfrom typing import Dict, List, Any, Optional\nfrom dataclasses import dataclass, field\nfrom datetime import datetime\nimport json\n\n\n@dataclass\nclass VisualizationTemplate:\n    \"\"\"可视化模板\"\"\"\n    template_id: str\n    name: str\n    category: str  # monitoring/forecast/emergency/analysis\n    description: str\n    version: str\n    config: Dict[str, Any]\n    preview_image: Optional[str] = None\n    tags: List[str] = field(default_factory=list)\n    created_at: datetime = field(default_factory=datetime.now)\n    usage_count: int = 0\n\n\n@dataclass\nclass TemplateBundle:\n    \"\"\"模板包\"\"\"\n    bundle_id: str\n    name: str\n    description: str\n    templates: List[VisualizationTemplate] = field(default_factory=list)\n    version: str = \"1.0\"\n    created_at: datetime = field(default_factory=datetime.now)\n\n\nclass TemplateLibrary:\n    \"\"\"可视化模板库\"\"\"\n\n    def __init__(self):\n        self.templates: Dict[str, VisualizationTemplate] = {}\n        self.bundles: Dict[str, TemplateBundle] = {}\n        self._initialize_builtin_templates()\n\n    def _initialize_builtin_templates(self):\n        \"\"\"初始化内置模板\"\"\"\n\n        # 1. 水位监测模板\n        water_level_template = VisualizationTemplate(\n            template_id=\"tpl_water_level_monitor\",\n            name=\"水位实时监测\",\n            category=\"monitoring\",\n            description=\"实时显示水位变化趋势及警戒线\",\n            version=\"1.0\",\n            config={\n                \"chart_type\": \"line\",\n                \"title\": \"水位变化趋势\",\n                \"layout\": {\n                    \"height\": 400,\n                    \"margin\": {\"top\": 20, \"right\": 20, \"bottom\": 20, \"left\": 50}\n                },\n                \"annotations\": [\n                    {\"type\": \"warning_line\", \"name\": \"警戒水位\"},\n                    {\"type\": \"danger_line\", \"name\": \"危险水位\"}\n                ],\n                \"interactions\": [\"zoom\", \"pan\", \"tooltip\"],\n                \"refresh_interval\": 60\n            },\n            tags=[\"monitoring\", \"water_level\", \"realtime\"]\n        )\n        self.templates[water_level_template.template_id] = water_level_template\n\n        # 2. 洪水风险评估模板\n        flood_risk_template = VisualizationTemplate(\n            template_id=\"tpl_flood_risk_assessment\",\n            name=\"洪水风险评估\",\n            category=\"emergency\",\n            description=\"多维度洪水风险评估及空间分布展示\",\n            version=\"1.0\",\n            config={\n                \"map_type\": \"flood_risk\",\n                \"title\": \"洪水风险分布\",\n                \"layers\": [\n                    {\"id\": \"risk_zones\", \"type\": \"fill\", \"paint\": {\"opacity\": 0.6}},\n                    {\"id\": \"risk_levels\", \"type\": \"symbol\", \"layout\": {}}\n                ],\n                \"style\": {\n                    \"colors\": {\n                        \"low\": \"#00FF00\",\n                        \"medium\": \"#FFFF00\",\n                        \"high\": \"#FFA500\",\n                        \"critical\": \"#FF0000\"\n                    }\n                },\n                \"controls\": [\"zoom\", \"pan\", \"legend\"],\n                \"refresh_interval\": 300\n            },\n            tags=[\"risk\", \"map\", \"flood\"]\n        )\n        self.templates[flood_risk_template.template_id] = flood_risk_template\n\n        # 3. 水库调度方案模板\n        reservoir_template = VisualizationTemplate(\n            template_id=\"tpl_reservoir_schedule\",\n            name=\"水库调度方案\",\n            category=\"analysis\",\n            description=\"水库运行模式和调度方案的综合展示\",\n            version=\"1.0\",\n            config={\n                \"chart_type\": \"mixed\",\n                \"title\": \"水库调度分析\",\n                \"components\": [\n                    {\"type\": \"line_chart\", \"data\": \"water_level\", \"width\": \"50%\"},\n                    {\"type\": \"bar_chart\", \"data\": \"discharge\", \"width\": \"50%\"},\n                    {\"type\": \"map\", \"data\": \"reservoir\", \"width\": \"100%\", \"height\": 300}\n                ],\n                \"metrics\": [\n                    {\"name\": \"current_level\", \"unit\": \"m\"},\n                    {\"name\": \"inflow\", \"unit\": \"m³/s\"},\n                    {\"name\": \"outflow\", \"unit\": \"m³/s\"},\n                    {\"name\": \"storage_ratio\", \"unit\": \"%\"}\n                ],\n                \"refresh_interval\": 600\n            },\n            tags=[\"reservoir\", \"analysis\", \"schedule\"]\n        )\n        self.templates[reservoir_template.template_id] = reservoir_template\n\n        # 4. 预测预报模板\n        prediction_template = VisualizationTemplate(\n            template_id=\"tpl_prediction_forecast\",\n            name=\"水文要素预报\",\n            category=\"forecast\",\n            description=\"24小时/7天水文要素预报及置信区间\",\n            version=\"1.0\",\n            config={\n                \"chart_type\": \"line_with_band\",\n                \"title\": \"水文要素预报\",\n                \"forecast_hours\": 24,\n                \"datasets\": [\n                    {\"name\": \"historical\", \"type\": \"line\", \"color\": \"#0066CC\"},\n                    {\"name\": \"forecast\", \"type\": \"line\", \"color\": \"#FF6600\"},\n                    {\"name\": \"confidence_upper\", \"type\": \"area\", \"opacity\": 0.2},\n                    {\"name\": \"confidence_lower\", \"type\": \"area\", \"opacity\": 0.2}\n                ],\n                \"threshold_lines\": [\n                    {\"value\": \"warning_level\", \"label\": \"警戒值\", \"color\": \"#FFA500\"},\n                    {\"value\": \"danger_level\", \"label\": \"危险值\", \"color\": \"#FF0000\"}\n                ],\n                \"refresh_interval\": 3600\n            },\n            tags=[\"prediction\", \"forecast\", \"timeseries\"]\n        )\n        self.templates[prediction_template.template_id] = prediction_template\n\n        # 5. 异常检测模板\n        anomaly_template = VisualizationTemplate(\n            template_id=\"tpl_anomaly_detection\",\n            name=\"异常检测结果\",\n            category=\"analysis\",\n            description=\"多维度数据异常检测及可视化\",\n            version=\"1.0\",\n            config={\n                \"chart_type\": \"scatter\",\n                \"title\": \"异常检测结果\",\n                \"data_representation\": {\n                    \"normal_points\": {\"color\": \"#0066CC\", \"size\": 4},\n                    \"anomaly_points\": {\"color\": \"#FF0000\", \"size\": 8}\n                },\n                \"detection_methods\": [\"isolation_forest\", \"zscore\", \"isolation_forest\"],\n                \"metrics\": [\n                    {\"name\": \"anomaly_score\", \"type\": \"continuous\"},\n                    {\"name\": \"confidence\", \"type\": \"percentage\"},\n                    {\"name\": \"detection_time\", \"type\": \"timestamp\"}\n                ],\n                \"refresh_interval\": 300\n            },\n            tags=[\"anomaly\", \"detection\", \"analysis\"]\n        )\n        self.templates[anomaly_template.template_id] = anomaly_template\n\n        # 6. 3D洪水淹没模板\n        flood_3d_template = VisualizationTemplate(\n            template_id=\"tpl_flood_3d_submersion\",\n            name=\"3D洪水淹没模拟\",\n            category=\"emergency\",\n            description=\"3D场景中展示洪水淹没范围及演进过程\",\n            version=\"1.0\",\n            config={\n                \"scene_type\": \"3d_flood\",\n                \"title\": \"洪水淹没3D模拟\",\n                \"layers\": [\n                    {\"id\": \"terrain\", \"type\": \"TerrainLayer\"},\n                    {\"id\": \"flood_water\", \"type\": \"PolygonLayer\"},\n                    {\"id\": \"affected_areas\", \"type\": \"PolygonLayer\"}\n                ],\n                \"view_state\": {\n                    \"pitch\": 60,\n                    \"bearing\": 0,\n                    \"zoom\": 12\n                },\n                \"animation\": {\n                    \"enabled\": True,\n                    \"duration\": 10000,\n                    \"frame_rate\": 30\n                },\n                \"refresh_interval\": 5000\n            },\n            tags=[\"3d\", \"flood\", \"simulation\", \"emergency\"]\n        )\n        self.templates[flood_3d_template.template_id] = flood_3d_template\n\n        # 7. 监测仪表板模板\n        dashboard_template = VisualizationTemplate(\n            template_id=\"tpl_monitoring_dashboard\",\n            name=\"综合监测仪表板\",\n            category=\"monitoring\",\n            description=\"多维度实时监测数据的综合展示仪表板\",\n            version=\"1.0\",\n            config={\n                \"dashboard_type\": \"comprehensive\",\n                \"title\": \"综合监测仪表板\",\n                \"layout\": {\n                    \"type\": \"grid\",\n                    \"columns\": 3,\n                    \"gap\": 20\n                },\n                \"components\": [\n                    {\"type\": \"metric_card\", \"metric\": \"water_level\", \"position\": [0, 0]},\n                    {\"type\": \"metric_card\", \"metric\": \"discharge\", \"position\": [0, 1]},\n                    {\"type\": \"metric_card\", \"metric\": \"temperature\", \"position\": [0, 2]},\n                    {\"type\": \"line_chart\", \"metric\": \"water_level_trend\", \"position\": [1, 0], \"width\": 2},\n                    {\"type\": \"bar_chart\", \"metric\": \"discharge_24h\", \"position\": [1, 2]},\n                    {\"type\": \"map\", \"metric\": \"station_map\", \"position\": [2, 0], \"width\": 3, \"height\": 2}\n                ],\n                \"refresh_interval\": 60\n            },\n            tags=[\"dashboard\", \"monitoring\", \"comprehensive\"]\n        )\n        self.templates[dashboard_template.template_id] = dashboard_template\n\n        # 8. 应急响应模板\n        emergency_template = VisualizationTemplate(\n            template_id=\"tpl_emergency_response\",\n            name=\"应急响应展示\",\n            category=\"emergency\",\n            description=\"应急事件的实时监测和响应措施展示\",\n            version=\"1.0\",\n            config={\n                \"emergency_type\": \"multi\",\n                \"title\": \"应急响应中心\",\n                \"components\": [\n                    {\"type\": \"status_board\", \"title\": \"应急状态\"},\n                    {\"type\": \"map\", \"title\": \"事件分布\"},\n                    {\"type\": \"timeline\", \"title\": \"事件时间线\"},\n                    {\"type\": \"video_wall\", \"title\": \"监控视频墙\"}\n                ],\n                \"alert_levels\": {\n                    \"low\": {\"color\": \"#FFA500\", \"sound\": True},\n                    \"medium\": {\"color\": \"#FF6600\", \"sound\": True},\n                    \"high\": {\"color\": \"#FF0000\", \"sound\": True, \"vibration\": True}\n                },\n                \"refresh_interval\": 10\n            },\n            tags=[\"emergency\", \"response\", \"alert\"]\n        )\n        self.templates[emergency_template.template_id] = emergency_template\n\n    def get_template(self, template_id: str) -> Optional[VisualizationTemplate]:\n        \"\"\"获取模板\"\"\"\n        template = self.templates.get(template_id)\n        if template:\n            template.usage_count += 1\n        return template\n\n    def list_templates(self, category: Optional[str] = None) -> List[VisualizationTemplate]:\n        \"\"\"列表模板\"\"\"\n        templates = list(self.templates.values())\n        if category:\n            templates = [t for t in templates if t.category == category]\n        return sorted(templates, key=lambda t: t.usage_count, reverse=True)\n\n    def search_templates(self, query: str, category: Optional[str] = None) -> List[VisualizationTemplate]:\n        \"\"\"搜索模板\"\"\"\n        query = query.lower()\n        results = []\n\n        for template in self.templates.values():\n            # 按名称、描述、标签搜索\n            match = (query in template.name.lower() or\n                    query in template.description.lower() or\n                    any(query in tag.lower() for tag in template.tags))\n\n            if match:\n                if category is None or template.category == category:\n                    results.append(template)\n\n        return results\n\n    def apply_template(self, template: VisualizationTemplate, data: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        应用模板\n\n        Args:\n            template: 模板\n            data: 输入数据\n\n        Returns:\n            应用后的配置\n        \"\"\"\n        result = {\n            \"template_id\": template.template_id,\n            \"template_name\": template.name,\n            \"config\": template.config.copy(),\n            \"data\": data,\n            \"applied_at\": datetime.now().isoformat()\n        }\n\n        # 根据数据自适应调整配置\n        if \"chart_type\" in template.config and data:\n            # 自动填充数据\n            result[\"config\"][\"data\"] = data\n\n            # 自动调整范围\n            if isinstance(data, dict):\n                if \"values\" in data:\n                    values = data[\"values\"]\n                    result[\"config\"][\"min_value\"] = min(values) if values else 0\n                    result[\"config\"][\"max_value\"] = max(values) if values else 100\n\n        return result\n\n    def create_bundle(self, bundle_name: str, template_ids: List[str]) -> TemplateBundle:\n        \"\"\"\n        创建模板包\n\n        Args:\n            bundle_name: 包名称\n            template_ids: 模板ID列表\n\n        Returns:\n            模板包\n        \"\"\"\n        bundle_id = f\"bundle_{bundle_name}_{len(self.bundles)}\"\n\n        templates = []\n        for tpl_id in template_ids:\n            if tpl_id in self.templates:\n                templates.append(self.templates[tpl_id])\n\n        bundle = TemplateBundle(\n            bundle_id=bundle_id,\n            name=bundle_name,\n            description=f\"包含{len(templates)}个模板的预置包\",\n            templates=templates\n        )\n\n        self.bundles[bundle_id] = bundle\n        return bundle\n\n    def get_template_bundle(self, bundle_name: str) -> Optional[Dict[str, Any]]:\n        \"\"\"获取模板包\"\"\"\n        for bundle_id, bundle in self.bundles.items():\n            if bundle.name == bundle_name:\n                return {\n                    \"bundle_id\": bundle.bundle_id,\n                    \"name\": bundle.name,\n                    \"description\": bundle.description,\n                    \"template_count\": len(bundle.templates),\n                    \"templates\": [\n                        {\n                            \"template_id\": t.template_id,\n                            \"name\": t.name,\n                            \"category\": t.category\n                        }\n                        for t in bundle.templates\n                    ]\n                }\n        return None\n\n    def get_recommended_templates(self, data_type: str, scenario: str) -> List[VisualizationTemplate]:\n        \"\"\"\n        获取推荐模板\n\n        Args:\n            data_type: 数据类型 (water_level, discharge, prediction等)\n            scenario: 使用场景 (monitoring, forecast, emergency等)\n\n        Returns:\n            推荐的模板列表\n        \"\"\"\n        recommendations = []\n\n        # 基于数据类型和场景的推荐规则\n        for template in self.templates.values():\n            # 检查标签匹配\n            if data_type in template.tags and scenario in template.tags:\n                recommendations.append(template)\n            elif scenario == template.category and data_type in template.tags:\n                recommendations.append(template)\n\n        # 按使用次数排序\n        return sorted(recommendations, key=lambda t: t.usage_count, reverse=True)\n\n    def export_template(self, template_id: str) -> str:\n        \"\"\"导出模板为JSON\"\"\"\n        template = self.get_template(template_id)\n        if not template:\n            raise ValueError(f\"Template {template_id} not found\")\n\n        return json.dumps({\n            \"template_id\": template.template_id,\n            \"name\": template.name,\n            \"category\": template.category,\n            \"description\": template.description,\n            \"config\": template.config,\n            \"tags\": template.tags\n        }, indent=2, ensure_ascii=False)\n\n    def get_statistics(self) -> Dict[str, Any]:\n        \"\"\"获取模板库统计信息\"\"\"\n        return {\n            \"total_templates\": len(self.templates),\n            \"total_bundles\": len(self.bundles),\n            \"templates_by_category\": self._count_by_category(),\n            \"most_used_templates\": self._get_top_used_templates(5),\n            \"total_usage\": sum(t.usage_count for t in self.templates.values())\n        }\n\n    def _count_by_category(self) -> Dict[str, int]:\n        \"\"\"按类别计数\"\"\"\n        counts = {}\n        for template in self.templates.values():\n            counts[template.category] = counts.get(template.category, 0) + 1\n        return counts\n\n    def _get_top_used_templates(self, limit: int = 5) -> List[Dict[str, Any]]:\n        \"\"\"获取最常用的模板\"\"\"\n        sorted_templates = sorted(\n            self.templates.values(),\n            key=lambda t: t.usage_count,\n            reverse=True\n        )[:limit]\n\n        return [\n            {\n                \"template_id\": t.template_id,\n                \"name\": t.name,\n                \"usage_count\": t.usage_count\n            }\n            for t in sorted_templates\n        ]\n"
